FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV RANGER_VERSION=2.4.0

# ----------- Dependências -----------
RUN apt-get update && \
    apt-get install -y openjdk-11-jdk wget curl \
                       python3 python3-pip sudo bc \
                       netcat-openbsd net-tools && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

# ----------- Baixa o Ranger PRÉ-COMPILADO -----------
WORKDIR /opt

# Baixa o tarball oficial (muito mais rápido que compilar!)
RUN wget -q https://archive.apache.org/dist/ranger/${RANGER_VERSION}/apache-ranger-${RANGER_VERSION}.tar.gz && \
    tar -xzf apache-ranger-${RANGER_VERSION}.tar.gz && \
    rm apache-ranger-${RANGER_VERSION}.tar.gz

# Extrai o ranger-admin
RUN tar -xzf /opt/apache-ranger-${RANGER_VERSION}/target/ranger-${RANGER_VERSION}-admin.tar.gz -C /opt && \
    rm -rf /opt/apache-ranger-${RANGER_VERSION}

WORKDIR /opt/ranger-${RANGER_VERSION}-admin

# ----------- Copia arquivos de configuração -----------
COPY install.properties /opt/ranger-${RANGER_VERSION}-admin/install.properties
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ----------- Baixa o driver PostgreSQL -----------
RUN wget -q https://jdbc.postgresql.org/download/postgresql-42.7.3.jar -P /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/

EXPOSE 6080

ENTRYPOINT ["/entrypoint.sh"]
