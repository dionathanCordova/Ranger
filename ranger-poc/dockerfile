FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV RANGER_VERSION=2.4.0

# ----------- Dependências -----------
RUN apt-get update && \
    apt-get install -y openjdk-11-jdk wget curl \
                       python3 python3-pip sudo bc \
                       netcat-openbsd net-tools && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

# ----------- Baixa o Ranger PRÉ-COMPILADO -----------
WORKDIR /opt

# Baixa o tarball oficial (muito mais rápido que compilar!)
# Usa múltiplas tentativas, URLs alternativas e melhor tratamento de erros
RUN set -eux; \
    echo "=========================================="; \
    echo "Baixando Apache Ranger ${RANGER_VERSION}..."; \
    echo "=========================================="; \
    DOWNLOAD_SUCCESS=false; \
    for URL in \
        "https://archive.apache.org/dist/ranger/${RANGER_VERSION}/apache-ranger-${RANGER_VERSION}.tar.gz" \
        "https://downloads.apache.org/ranger/${RANGER_VERSION}/apache-ranger-${RANGER_VERSION}.tar.gz" \
        "https://dlcdn.apache.org/ranger/${RANGER_VERSION}/apache-ranger-${RANGER_VERSION}.tar.gz"; \
    do \
        echo "Tentando baixar de: $URL"; \
        if wget --tries=3 --timeout=60 --progress=dot:giga --no-check-certificate \
            "$URL" -O apache-ranger-${RANGER_VERSION}.tar.gz 2>&1; then \
            if [ -f apache-ranger-${RANGER_VERSION}.tar.gz ] && [ -s apache-ranger-${RANGER_VERSION}.tar.gz ]; then \
                echo "✅ Download bem-sucedido!"; \
                DOWNLOAD_SUCCESS=true; \
                break; \
            else \
                echo "⚠️  Arquivo baixado está vazio ou corrompido. Tentando próxima URL..."; \
                rm -f apache-ranger-${RANGER_VERSION}.tar.gz; \
            fi; \
        else \
            echo "⚠️  Falha no download. Tentando próxima URL..."; \
            rm -f apache-ranger-${RANGER_VERSION}.tar.gz; \
        fi; \
    done; \
    if [ "$DOWNLOAD_SUCCESS" = false ]; then \
        echo "❌ Erro: Não foi possível baixar Apache Ranger ${RANGER_VERSION}"; \
        echo "Verifique se a versão existe em: https://archive.apache.org/dist/ranger/"; \
        echo "Versões disponíveis podem ser verificadas em: https://archive.apache.org/dist/ranger/"; \
        exit 1; \
    fi; \
    echo "✅ Download concluído. Verificando integridade..."; \
    if ! tar -tzf apache-ranger-${RANGER_VERSION}.tar.gz > /dev/null 2>&1; then \
        echo "❌ Erro: Arquivo tar.gz está corrompido!"; \
        exit 1; \
    fi; \
    echo "✅ Arquivo válido. Extraindo..."; \
    tar -xzf apache-ranger-${RANGER_VERSION}.tar.gz && \
    rm apache-ranger-${RANGER_VERSION}.tar.gz && \
    echo "✅ Extração concluída."

# Extrai o ranger-admin
# Verifica se o arquivo admin existe antes de extrair
RUN if [ -f /opt/apache-ranger-${RANGER_VERSION}/target/ranger-${RANGER_VERSION}-admin.tar.gz ]; then \
        echo "✅ Extraindo ranger-admin..."; \
        tar -xzf /opt/apache-ranger-${RANGER_VERSION}/target/ranger-${RANGER_VERSION}-admin.tar.gz -C /opt && \
        rm -rf /opt/apache-ranger-${RANGER_VERSION} && \
        echo "✅ Ranger-admin extraído com sucesso."; \
    elif [ -f /opt/apache-ranger-${RANGER_VERSION}/ranger-${RANGER_VERSION}-admin.tar.gz ]; then \
        echo "✅ Extraindo ranger-admin (localização alternativa)..."; \
        tar -xzf /opt/apache-ranger-${RANGER_VERSION}/ranger-${RANGER_VERSION}-admin.tar.gz -C /opt && \
        rm -rf /opt/apache-ranger-${RANGER_VERSION} && \
        echo "✅ Ranger-admin extraído com sucesso."; \
    else \
        echo "❌ Erro: Arquivo ranger-admin não encontrado."; \
        echo "Estrutura do diretório:"; \
        ls -la /opt/apache-ranger-${RANGER_VERSION}/ || true; \
        find /opt/apache-ranger-${RANGER_VERSION}/ -name "*admin*.tar.gz" || true; \
        exit 1; \
    fi

WORKDIR /opt/ranger-${RANGER_VERSION}-admin

# ----------- Copia arquivos de configuração -----------
COPY install.properties /opt/ranger-${RANGER_VERSION}-admin/install.properties
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ----------- Baixa o driver PostgreSQL -----------
RUN echo "Baixando driver PostgreSQL JDBC..."; \
    wget --tries=3 --timeout=30 --no-check-certificate \
        https://jdbc.postgresql.org/download/postgresql-42.7.3.jar \
        -P /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/ || \
    wget --tries=3 --timeout=30 --no-check-certificate \
        https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.3/postgresql-42.7.3.jar \
        -O /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/postgresql-42.7.3.jar || \
    (echo "⚠️  Aviso: Não foi possível baixar o driver PostgreSQL. Continuando..." && \
     mkdir -p /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/); \
    echo "✅ Driver PostgreSQL configurado."

EXPOSE 6080

ENTRYPOINT ["/entrypoint.sh"]
