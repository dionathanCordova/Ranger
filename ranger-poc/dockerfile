FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV RANGER_VERSION=2.4.0

# ----------- Dependências -----------
RUN apt-get update && \
    apt-get install -y openjdk-11-jdk wget curl \
                       python3 python3-pip sudo bc \
                       netcat-openbsd net-tools \
                       && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

WORKDIR /opt

# ----------- Baixa diretamente o binário do Ranger Admin -----------
# Em vez de baixar o código-fonte completo e compilar, usamos apenas o pacote admin pré-compilado.
# Isso evita builds extremamente longos/travados dentro do container.
RUN set -eux; \
    echo "=========================================="; \
    echo "Baixando pacote binário ranger-${RANGER_VERSION}-admin..."; \
    echo "=========================================="; \
    DOWNLOAD_SUCCESS=false; \
    for URL in \
        "https://archive.apache.org/dist/ranger/${RANGER_VERSION}/ranger-${RANGER_VERSION}-admin.tar.gz" \
        "https://downloads.apache.org/ranger/${RANGER_VERSION}/ranger-${RANGER_VERSION}-admin.tar.gz" \
        "https://dlcdn.apache.org/ranger/${RANGER_VERSION}/ranger-${RANGER_VERSION}-admin.tar.gz"; \
    do \
        echo "Tentando baixar de: $URL"; \
        if wget --tries=3 --timeout=60 --progress=dot:giga --no-check-certificate \
            "$URL" -O ranger-${RANGER_VERSION}-admin.tar.gz 2>&1; then \
            if [ -f ranger-${RANGER_VERSION}-admin.tar.gz ] && [ -s ranger-${RANGER_VERSION}-admin.tar.gz ]; then \
                echo "✅ Download do ranger-admin bem-sucedido!"; \
                DOWNLOAD_SUCCESS=true; \
                break; \
            else \
                echo "⚠️  Arquivo baixado está vazio ou corrompido. Tentando próxima URL..."; \
                rm -f ranger-${RANGER_VERSION}-admin.tar.gz; \
            fi; \
        else \
            echo "⚠️  Falha no download. Tentando próxima URL..."; \
            rm -f ranger-${RANGER_VERSION}-admin.tar.gz; \
        fi; \
    done; \
    if [ "$DOWNLOAD_SUCCESS" = false ]; then \
        echo "❌ Erro: Não foi possível baixar ranger-${RANGER_VERSION}-admin.tar.gz"; \
        echo "Verifique se a versão existe em: https://archive.apache.org/dist/ranger/${RANGER_VERSION}/"; \
        exit 1; \
    fi; \
    echo "✅ Download concluído. Verificando integridade..."; \
    if ! tar -tzf ranger-${RANGER_VERSION}-admin.tar.gz > /dev/null 2>&1; then \
        echo "❌ Erro: Arquivo ranger-${RANGER_VERSION}-admin.tar.gz está corrompido!"; \
        exit 1; \
    fi; \
    echo "✅ Arquivo válido. Extraindo para /opt..."; \
    tar -xzf ranger-${RANGER_VERSION}-admin.tar.gz -C /opt && \
    rm ranger-${RANGER_VERSION}-admin.tar.gz && \
    echo "✅ Extração concluída."; \
    if [ ! -d "/opt/ranger-${RANGER_VERSION}-admin" ] || [ ! -f "/opt/ranger-${RANGER_VERSION}-admin/ews/ranger-admin-services.sh" ]; then \
        echo "❌ Erro: diretório /opt/ranger-${RANGER_VERSION}-admin não encontrado após extração."; \
        echo "Conteúdo de /opt:"; \
        ls -la /opt || true; \
        exit 1; \
    fi; \
    echo "✅ ranger-${RANGER_VERSION}-admin disponível em /opt/ranger-${RANGER_VERSION}-admin"

WORKDIR /opt/ranger-${RANGER_VERSION}-admin

# ----------- Copia arquivos de configuração -----------
COPY install.properties /opt/ranger-${RANGER_VERSION}-admin/install.properties
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ----------- Baixa o driver PostgreSQL -----------
RUN echo "Baixando driver PostgreSQL JDBC..."; \
    wget --tries=3 --timeout=30 --no-check-certificate \
        https://jdbc.postgresql.org/download/postgresql-42.7.3.jar \
        -P /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/ || \
    wget --tries=3 --timeout=30 --no-check-certificate \
        https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.3/postgresql-42.7.3.jar \
        -O /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/postgresql-42.7.3.jar || \
    (echo "⚠️  Aviso: Não foi possível baixar o driver PostgreSQL. Continuando..." && \
     mkdir -p /opt/ranger-${RANGER_VERSION}-admin/ews/webapp/WEB-INF/lib/); \
    echo "✅ Driver PostgreSQL configurado."

EXPOSE 6080

ENTRYPOINT ["/entrypoint.sh"]
